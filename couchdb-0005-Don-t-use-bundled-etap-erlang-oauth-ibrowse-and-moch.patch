From 535710a2c8723f3bb598a754ae60490724d70eec Mon Sep 17 00:00:00 2001
From: Peter Lemenkov <lemenkov@gmail.com>
Date: Sun, 15 May 2011 18:47:41 +0400
Subject: [PATCH 5/8] Don't use bundled etap, erlang-oauth, ibrowse and
 mochiweb

Signed-off-by: Peter Lemenkov <lemenkov@gmail.com>
---
 configure.ac                     |  6 +-----
 src/Makefile.am                  |  2 +-
 src/couchdb/priv/couch_js/http.c | 14 --------------
 src/ejson/Makefile.am            |  8 ++------
 test/etap/test_util.erl.in       |  2 +-
 5 files changed, 5 insertions(+), 27 deletions(-)

diff --git a/configure.ac b/configure.ac
index 5ce0e96..f411bbf 100644
--- a/configure.ac
+++ b/configure.ac
@@ -389,7 +389,7 @@ AC_ARG_WITH([win32-curl], [AC_HELP_STRING([--with-win32-curl=PATH],
     # OpenSSL libraries may be pulled in via libcurl if it was built with SSL
     # these are libeay32 ssleay32 instead of crypto ssl on unix
 ], [
-    AC_CHECK_CURL([7.18.0],
+    AC_CHECK_CURL([7.15.0],
         [AC_DEFINE([HAVE_CURL], [1], ["Provide HTTP support to couchjs"])], [
         AC_MSG_WARN([You will be unable to run some JavaScript unit tests.])
         use_curl=no
@@ -599,10 +599,6 @@ AC_CONFIG_FILES([src/Makefile])
 AC_CONFIG_FILES([src/couchdb/couch.app.tpl])
 AC_CONFIG_FILES([src/couchdb/Makefile])
 AC_CONFIG_FILES([src/couchdb/priv/Makefile])
-AC_CONFIG_FILES([src/erlang-oauth/Makefile])
-AC_CONFIG_FILES([src/etap/Makefile])
-AC_CONFIG_FILES([src/ibrowse/Makefile])
-AC_CONFIG_FILES([src/mochiweb/Makefile])
 AC_CONFIG_FILES([src/snappy/Makefile])
 AC_CONFIG_FILES([src/snappy/google-snappy/snappy-stubs-public.h])
 AC_CONFIG_FILES([src/ejson/Makefile])
diff --git a/src/Makefile.am b/src/Makefile.am
index 047f1ee..457640c 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -10,4 +10,4 @@
 ## License for the specific language governing permissions and limitations under
 ## the License.
 
-SUBDIRS = couchdb ejson erlang-oauth etap ibrowse mochiweb snappy
+SUBDIRS = couchdb ejson snappy
diff --git a/src/couchdb/priv/couch_js/http.c b/src/couchdb/priv/couch_js/http.c
index 0685abb..307b291 100644
--- a/src/couchdb/priv/couch_js/http.c
+++ b/src/couchdb/priv/couch_js/http.c
@@ -364,7 +364,6 @@ CURL*       HTTP_HANDLE = NULL;
 char        ERRBUF[CURL_ERROR_SIZE];
 
 static size_t send_body(void *ptr, size_t size, size_t nmem, void *data);
-static int seek_body(void *ptr, curl_off_t offset, int origin);
 static size_t recv_body(void *ptr, size_t size, size_t nmem, void *data);
 static size_t recv_header(void *ptr, size_t size, size_t nmem, void *data);
 
@@ -391,8 +390,6 @@ go(JSContext* cx, JSObject* obj, HTTPData* http, char* body, size_t bodylen)
     if(HTTP_HANDLE == NULL) {
         HTTP_HANDLE = curl_easy_init();
         curl_easy_setopt(HTTP_HANDLE, CURLOPT_READFUNCTION, send_body);
-        curl_easy_setopt(HTTP_HANDLE, CURLOPT_SEEKFUNCTION,
-                                        (curl_seek_callback) seek_body);
         curl_easy_setopt(HTTP_HANDLE, CURLOPT_HEADERFUNCTION, recv_header);
         curl_easy_setopt(HTTP_HANDLE, CURLOPT_WRITEFUNCTION, recv_body);
         curl_easy_setopt(HTTP_HANDLE, CURLOPT_NOPROGRESS, 1);
@@ -437,7 +434,6 @@ go(JSContext* cx, JSObject* obj, HTTPData* http, char* body, size_t bodylen)
     curl_easy_setopt(HTTP_HANDLE, CURLOPT_URL, http->url);
     curl_easy_setopt(HTTP_HANDLE, CURLOPT_HTTPHEADER, http->req_headers);
     curl_easy_setopt(HTTP_HANDLE, CURLOPT_READDATA, &state);
-    curl_easy_setopt(HTTP_HANDLE, CURLOPT_SEEKDATA, &state);
     curl_easy_setopt(HTTP_HANDLE, CURLOPT_WRITEHEADER, &state);
     curl_easy_setopt(HTTP_HANDLE, CURLOPT_WRITEDATA, &state);
 
@@ -527,16 +523,6 @@ send_body(void *ptr, size_t size, size_t nmem, void *data)
     return towrite;
 }
 
-static int
-seek_body(void* ptr, curl_off_t offset, int origin)
-{
-    CurlState* state = (CurlState*) ptr;
-    if(origin != SEEK_SET) return -1;
-
-    state->sent = (size_t) offset;
-    return (int) state->sent;
-}
-
 static size_t
 recv_header(void *ptr, size_t size, size_t nmem, void *data)
 {
diff --git a/src/ejson/Makefile.am b/src/ejson/Makefile.am
index c1e07db..6f2dfaa 100644
--- a/src/ejson/Makefile.am
+++ b/src/ejson/Makefile.am
@@ -44,15 +44,11 @@ EJSON_C_HDRS = \
 
 ejson_file_collection = \
     ejson.app.in \
-    ejson.erl \
-    mochijson2.erl \
-    mochinum.erl
+    ejson.erl
 
 ejsonebin_make_generated_file_list = \
     ejson.app \
-    ejson.beam \
-    mochijson2.beam \
-    mochinum.beam
+    ejson.beam
 
 EXTRA_DIST = \
 	$(EJSON_C_HDRS) \
diff --git a/test/etap/test_util.erl.in b/test/etap/test_util.erl.in
index f17be20..759eb09 100644
--- a/test/etap/test_util.erl.in
+++ b/test/etap/test_util.erl.in
@@ -23,7 +23,7 @@ builddir() ->
     "@abs_top_builddir@".
 
 init_code_path() ->
-    Paths = ["etap", "couchdb", "ejson", "erlang-oauth", "ibrowse", "mochiweb",
+    Paths = ["couchdb", "ejson",
              "snappy"],
     lists:foreach(fun(Name) ->
         code:add_patha(filename:join([builddir(), "src", Name]))
-- 
1.7.12

