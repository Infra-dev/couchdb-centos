From 8741c02edcd6251a01774471d51325ac7bf055f5 Mon Sep 17 00:00:00 2001
From: Peter Lemenkov <lemenkov@gmail.com>
Date: Sun, 13 Feb 2011 14:52:57 +0300
Subject: [PATCH 09/13] Fixes for system-wide ibrowse

Signed-off-by: Peter Lemenkov <lemenkov@gmail.com>
---
 src/couchdb/couch_rep_changes_feed.erl |    2 +-
 src/couchdb/couch_rep_httpc.erl        |    4 ++--
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/src/couchdb/couch_rep_changes_feed.erl b/src/couchdb/couch_rep_changes_feed.erl
index 4d1afcb..032f62a 100644
--- a/src/couchdb/couch_rep_changes_feed.erl
+++ b/src/couchdb/couch_rep_changes_feed.erl
@@ -20,7 +20,7 @@
 -define(BUFFER_SIZE, 1000).
 
 -include("couch_db.hrl").
--include("../ibrowse/ibrowse.hrl").
+-include_lib("ibrowse/include/ibrowse.hrl").
 
 -record (state, {
     changes_from = nil,
diff --git a/src/couchdb/couch_rep_httpc.erl b/src/couchdb/couch_rep_httpc.erl
index e535c0d..e13b00c 100644
--- a/src/couchdb/couch_rep_httpc.erl
+++ b/src/couchdb/couch_rep_httpc.erl
@@ -12,7 +12,7 @@
 
 -module(couch_rep_httpc).
 -include("couch_db.hrl").
--include("../ibrowse/ibrowse.hrl").
+-include_lib("ibrowse/include/ibrowse.hrl").
 
 -export([db_exists/1, db_exists/2, full_url/1, request/1, redirected_request/2,
     redirect_url/2, spawn_worker_process/1, spawn_link_worker_process/1]).
@@ -218,7 +218,7 @@ redirected_request(Req, RedirectUrl) ->
 
 spawn_worker_process(Req) ->
     Url = ibrowse_lib:parse_url(Req#http_db.url),
-    {ok, Pid} = ibrowse_http_client:start(Url),
+    {ok, Pid} = ibrowse_http_client:start({undefined, Url, {[{ssl_imp, new}], (Url#url.protocol == https)}}),
     Pid.
 
 spawn_link_worker_process(Req) ->
-- 
1.7.4

